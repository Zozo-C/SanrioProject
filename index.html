<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°è‘µçš„ä¸‰éº—é·—å¤¢æƒ³èˆå°</title>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet" />
    
    <!-- æˆªåœ–åŠŸèƒ½åº« (å¿…é ˆæœ‰ç¶²è·¯æ‰èƒ½é‹ä½œ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ========================================= */
        /* ğŸŒ¸ åŸºç¤è¨­å®š & è®Šæ•¸ */
        /* ========================================= */

        :root {
            --bg: #fffafc;
            --card-bg: #ffffff;
            --card-border: #ffe6f3;
            --text-main: #ff66a3;
            --text-dark: #5d4037;
            --accent: #ff85b3;
            --btn-bg: #ff7fb8;
            --btn-bg-dark: #ff559f;
            --soft-shadow: 0 8px 20px rgba(255, 150, 200, 0.25);
            --font-main: 'Zen Maru Gothic', sans-serif;
            --deadline-color: #ff5252;
            
            /* åˆ†äº«å¡ç‰‡è®Šæ•¸ */
            --share-bg: #ffffff;
            --share-pattern: none;
            --share-border: 4px solid var(--card-border);
        }

        /* ============================= */
        /* ğŸ€ ä¸»é¡Œè‰²åˆ‡æ› (è‰²å½©ç„¡éšœç¤™å„ªåŒ–ç‰ˆ) */
        /* ============================= */

        [data-theme="melody"] {
            --bg: #fff6fb;
            --card-border: #ffd8ec;
            --accent: #d65a88;
            --btn-bg: #ff8ac6;
            --text-dark: #6b3030;
            --soft-shadow: 0 8px 20px rgba(255, 138, 198, 0.25);
        }

        [data-theme="cinnamoroll"] {
            --bg: #f0f8ff;
            --card-border: #cce9ff;
            --accent: #0077be;
            --btn-bg: #4a90e2;
            --text-dark: #1a3c5e;
            --soft-shadow: 0 8px 20px rgba(74, 144, 226, 0.2);
        }

        [data-theme="kuromi"] {
            --bg: #fcfaff;
            --card-border: #e0d4fc;
            --accent: #8a63cc;
            --btn-bg: #9b7bdb;
            --text-dark: #3a2a4d;
            --soft-shadow: 0 8px 20px rgba(155, 123, 219, 0.25);
        }

        [data-theme="pompompurin"] {
            --bg: #fffdf5;
            --card-border: #fceea4;
            --accent: #d48806;
            --btn-bg: #f5c242;
            --text-dark: #4e342e;
            --soft-shadow: 0 8px 20px rgba(245, 194, 66, 0.25);
        }

        [data-theme="kitty"] {
            --bg: #fffafa;
            --card-border: #ffd1dc;
            --accent: #e0245e;
            --btn-bg: #ff6b8b;
            --text-dark: #5d2e2e;
            --soft-shadow: 0 8px 20px rgba(255, 107, 139, 0.25);
        }

        /* ========================================= */
        /* ğŸŒ¸ Layout */
        /* ========================================= */

        * {
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, border-radius 0.3s ease;
        }

        body {
            margin: 0;
            background: var(--bg);
            font-family: var(--font-main);
            color: var(--text-dark);
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            padding: 40px 10px 10px;
        }

        .main-title {
            font-size: 24px;
            color: var(--accent);
            font-weight: 700;
            margin: 0 0 8px 0;
            text-shadow: 2px 2px 0px #fff;
        }

        .deadline-tag {
            display: inline-block;
            background: var(--card-bg);
            border: 2px solid var(--deadline-color);
            color: var(--deadline-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .greeting {
            font-size: 16px;
            color: var(--text-dark);
            opacity: 0.9;
            font-weight: bold;
            margin-top: 10px;
        }

        .main-container {
            max-width: 500px;
            margin: auto;
            padding: 10px 20px;
        }

        /* ========================================= */
        /* â˜ï¸ æ£‰èŠ±ç³–æ³¡æ³¡é¢¨å¡ç‰‡ */
        /* ========================================= */

        .card {
            background: var(--card-bg);
            border-radius: 32px;
            padding: 24px;
            margin-bottom: 22px;
            border: 3px solid var(--card-border);
            box-shadow: var(--soft-shadow);
            position: relative;
        }

        .section-title {
            font-size: 18px;
            color: var(--accent);
            margin-bottom: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px dashed var(--card-border);
            padding-bottom: 10px;
        }

        /* ========================================= */
        /* ğŸŒ¸ Buttons & Inputs */
        /* ========================================= */

        button, .vote-link {
            font-family: var(--font-main);
            outline: none;
        }

        .vote-button,
        .modal-btn,
        .small-btn,
        .share-button,
        .settings-btn,
        .vote-link {
            background: var(--btn-bg);
            border: none;
            color: #fff;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: inline-block;
            text-decoration: none;
            text-align: center;
            font-weight: bold;
        }

        .vote-button:active,
        .modal-btn:active,
        .small-btn:active,
        .share-button:active,
        .settings-btn:active,
        .vote-link:active {
            transform: scale(0.96);
        }

        .vote-link {
            display: block;
            width: 100%;
            margin-bottom: 15px;
            background: var(--accent);
        }

        .vote-button {
            width: 100%;
            background: #fff;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .vote-button.disabled {
            background: #f0f0f0;
            border-color: #ddd;
            color: #aaa;
            cursor: not-allowed;
            box-shadow: none;
        }

        .small-btn {
            padding: 8px 16px;
            font-size: 14px;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            box-shadow: none;
        }

        .settings-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: #fff;
            color: var(--text-dark);
            border: 2px solid var(--card-border);
        }

        .delete-btn {
            background: #ff8ea3;
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 20px;
            margin-top: 20px;
            cursor: pointer;
        }

        .selector, .input, .textarea {
            width: 100%;
            border-radius: 18px;
            padding: 12px 14px;
            border: 2px solid var(--card-border);
            font-size: 16px;
            font-family: inherit;
            box-sizing: border-box;
            background: var(--bg);
            color: var(--text-dark);
            outline: none;
            margin: 5px 0;
        }

        .textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* ========================================= */
        /* ğŸ’¬ å°èª & å…§å®¹ */
        /* ========================================= */

        .daily-quote {
            font-size: 15px;
            color: var(--text-dark);
            padding: 15px;
            background: var(--bg);
            border-radius: 20px;
            text-align: center;
            font-style: italic;
            border: 1px solid var(--card-border);
        }

        .vote-msg {
            text-align: center;
            margin-top: 10px;
            min-height: 24px;
            font-size: 0.95rem;
            color: var(--accent);
            font-weight: bold;
        }

        /* ========================================= */
        /* ğŸ€ å¾½ç« æ¨£å¼èˆ‡å‹•ç•« */
        /* ========================================= */

        .today-badge-container {
            width: 120px;
            height: 120px;
            margin: 20px auto 10px;
            position: relative;
        }

        .today-badge {
            width: 100%;
            height: 100%;
            background: var(--card-border);
            /* border-radius ç”± shape é¡åˆ¥æ§åˆ¶ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: var(--text-dark);
            font-weight: bold;
            transition: all 0.3s;
        }

        .animate-pop {
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(10deg); opacity: 1; }
            80% { transform: scale(0.95) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* --- å¾½ç« é€ å‹ CSS --- */
        .shape-default { border-radius: 20px; }
        .shape-circle { border-radius: 50%; }
        .shape-stamp { border-radius: 4px; border: 3px dashed var(--accent) !important; background-color: #fff; }
        .shape-glow { border-radius: 20px; box-shadow: 0 0 10px var(--accent), 0 0 20px var(--btn-bg); border: 2px solid #fff; }

        /* ========================================= */
        /* ğŸŒˆ å¾½ç« å†Š */
        /* ========================================= */

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px; /* åŠ å¤§ padding é¿å…ç™¼å…‰æ•ˆæœè¢«åˆ‡æ‰ */
        }

        .badge {
            aspect-ratio: 1;
            background: var(--bg);
            /* border-radius ç§»é™¤ï¼Œæ”¹ç”± shape-class æ§åˆ¶ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 2px solid transparent;
            transition: transform 0.2s;
            position: relative;
        }
        
        .badge.locked {
            font-size: 14px;
            color: #ccc;
            background: #f5f5f5;
        }

        .badge.unlocked {
            border-color: var(--card-border);
            background: #fff;
        }

        .badge:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            z-index: 2;
        }

        .badge-grid.big {
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        }
        .badge-grid.big .badge {
            font-size: 45px;
        }

        .badge-carousel {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding: 10px 5px;
        }

        .badge-carousel .badge {
            min-width: 90px;
            height: 90px;
            background: var(--bg);
            font-size: 45px;
            flex-shrink: 0;
            border: 2px solid var(--card-border);
        }

        .hidden { display: none !important; }

        /* ========================================= */
        /* ğŸŒˆ æ—…ç¨‹æˆé•·æ¢ */
        /* ========================================= */

        .journey-text {
            text-align: center;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .progress-wrapper {
            width: 100%;
            height: 16px;
            background: var(--bg);
            border-radius: 20px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--btn-bg);
            border-radius: 20px;
            transition: width 1s ease;
        }

        /* ========================================= */
        /* â­ èƒŒæ™¯æ˜Ÿæ˜Ÿ */
        /* ========================================= */

        #starBackground {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0.6;
            animation: twinkle 3s infinite ease-in-out alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(0.8); }
            100% { opacity: 0.9; transform: scale(1.2); }
        }

        /* ========================================= */
        /* ğŸ€ MODALS */
        /* ========================================= */

        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s;
        }
        
        .modal.hidden {
            pointer-events: none;
            opacity: 0;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border-radius: 35px;
            border: 4px solid var(--card-border);
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .theme-btn {
            background: var(--bg);
            border: 2px solid var(--card-border);
            padding: 15px;
            border-radius: 20px;
            font-weight: bold;
            color: var(--text-dark);
            cursor: pointer;
        }
        .theme-btn:hover, .theme-btn.active {
            border-color: var(--accent);
            background: #fff;
            transform: scale(1.05);
        }

        .label {
            text-align: left;
            display: block;
            margin: 15px 0 5px;
            color: var(--accent);
            font-weight: bold;
        }

        /* ========================================= */
        /* ğŸ“· åˆ†äº«ç•«é¢ (å‹•æ…‹æ¨£å¼) */
        /* ========================================= */

        .share-content {
            width: 90%; 
            max-width: 420px;
            text-align: center;
        }
        
        /* åŸºç¤å¡ç‰‡è¨­å®š */
        .share-card {
            padding: 25px;
            border-radius: 30px;
            margin-bottom: 15px;
            color: var(--text-dark);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            text-align: center;
            
            /* å‹•æ…‹è®Šæ•¸ */
            background: var(--share-bg);
            border: var(--share-border);
        }

        .share-card .share-badge-large {
            width: 120px;
            height: 120px;
            margin: 10px auto;
            background: var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            animation: twinkle 3s infinite;
        }
        
        /* æ¨£å¼ 1: åœ“é»é¢¨ */
        .share-card.style-0 {
            background-color: #fff;
            background-image: radial-gradient(var(--card-border) 2px, transparent 2px);
            background-size: 20px 20px;
            border: 4px dashed var(--accent);
        }
        
        /* æ¨£å¼ 2: æ¼¸å±¤é¢¨ */
        .share-card.style-1 {
            background: linear-gradient(135deg, var(--bg) 0%, #fff 100%);
            border: 4px double var(--accent);
        }
        
        /* æ¨£å¼ 3: ç°¡ç´„è‰²å¡Š */
        .share-card.style-2 {
            background: var(--bg);
            border: 8px solid #fff;
            outline: 2px solid var(--card-border);
        }
        
        /* æ¨£å¼ 4: æ–œç´‹é¢¨ */
        .share-card.style-3 {
            background: repeating-linear-gradient(
              45deg,
              #fff,
              #fff 10px,
              var(--bg) 10px,
              var(--bg) 20px
            );
            border: 4px solid var(--text-main);
        }

        /* æ¨£å¼ 5: é‚Šæ¡†é¢¨ */
        .share-card.style-4 {
            background: #fff;
            border: 2px solid var(--card-border);
            box-shadow: inset 0 0 0 6px var(--bg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(2px);
        }

        .stat-num {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .share-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .share-actions .modal-btn {
            font-size: 14px;
            padding: 10px;
        }
    </style>
</head>

<body>

    <!-- ğŸŒ¸ æ´»å‹•ä¸»æ¨™ -->
    <header class="header">
        <h1 class="main-title">ğŸŒ¸ å°è‘µçš„ä¸‰éº—é·—å¤¢æƒ³èˆå° ğŸŒ¸</h1>
        <div class="deadline-tag">æŠ•ç¥¨æˆªæ­¢ï¼š12/22 23:59</div>
        <div id="greeting" class="greeting"></div>
    </header>

    <!-- ====================================== -->
    <!-- â˜ï¸ ä¸»å…§å®¹å€ -->
    <!-- ====================================== -->

    <main class="main-container">

        <!-- ä»Šæ—¥å°èªï¼ˆæ³¡æ³¡å¡ç‰‡ï¼‰ -->
        <section class="card bubble-card">
            <h2 class="section-title">ğŸ’¬ ä»Šæ—¥å°è‘µèªª</h2>
            <p id="dailyQuote" class="daily-quote"></p>
        </section>

        <!-- æŠ•ç¥¨å€å¡Šï¼ˆæ³¡æ³¡å¡ç‰‡ï¼‰ -->
        <section class="card bubble-card">
            <h2 class="section-title">ğŸ—³ï¸ æ‡‰æ´å°è‘µ</h2>
            <a id="voteLinkBtn" target="_blank" 
               href="https://sanriokids.sanrio.com.tw/videos/103?tid=630455c396ac04f98589ba1170f22c84"
               class="vote-link">å‰å¾€æŠ•ç¥¨é é¢ ğŸ—³ï¸</a>

            <button id="voteBtn" class="vote-button">æˆ‘ä»Šå¤©æœ‰æŠ•ç¥¨ï¼(æŠ½å¾½ç« )</button>
            
            <!-- æ–°å¢å¸¸é§æç¤º -->
            <p style="font-size: 0.85rem; color: #ff6b81; text-align: center; margin-top: 10px; font-weight: bold; line-height: 1.4;">
                ğŸ å°é©šå–œï¼šè‹¥æŠ½ä¸­ã€Œå‘æ—¥è‘µ ğŸŒ»ã€<br>
                è¨˜å¾—åˆ†äº«è²¼æ–‡ä¸¦æˆªåœ–å›å‚³çµ¦æˆ‘ / tagæˆ‘ï¼Œå¯å…Œæ› 45å…ƒé£²æ–™ä¸€æ¯ï¼
            </p>

            <div id="voteMsg" class="vote-msg"></div>

            <h3 class="section-title" style="margin-top:20px;">ğŸ€ ä»Šå¤©çš„å¾½ç« </h3>
            <div class="today-badge-container">
                <div id="todayBadge" class="today-badge">â“</div>
            </div>
        </section>

        <!-- å¾½ç« å†Šï¼ˆæ³¡æ³¡å¡ç‰‡ï¼‰ -->
        <section class="card bubble-card">
            <div class="flex-between">
                <h2 class="section-title">ğŸŒˆ æˆ‘çš„å¾½ç« å†Š</h2>

                <select id="badgeStyleSelector" class="selector" style="width: auto; padding: 5px 10px;">
                    <option value="grid">å°å¡</option>
                    <option value="big">å¤§å¡</option>
                    <option value="carousel">è¼ªæ’­</option>
                </select>
            </div>

            <div id="badgeGrid" class="badge-grid"></div>
            <div id="badgeCarousel" class="badge-carousel hidden"></div>
        </section>

        <!-- æ—…ç¨‹ç´€éŒ„ï¼ˆæ³¡æ³¡å¡ç‰‡ï¼‰ -->
        <section class="card bubble-card">
            <h2 class="section-title">ğŸ“… æ—…ç¨‹ç´€éŒ„</h2>
            <p id="journeyText" class="journey-text"></p>

            <div class="progress-wrapper">
                <div id="journeyBar" class="progress-bar"></div>
            </div>
            <p id="targetText" style="text-align:center; font-size:0.8rem; margin-top:8px; color:#999;"></p>
        </section>

        <!-- åˆ†äº«æ¨¡å¼ï¼ˆæ³¡æ³¡å¡ç‰‡ï¼‰ -->
        <section class="card bubble-card">
            <h2 class="section-title">ğŸ“· åˆ†äº«æ‡‰æ´å¡</h2>
            <button id="shareBtn" class="share-button">è¼¸å…¥ç¥ç¦ä¸¦ç”Ÿæˆå¡ç‰‡</button>
        </section>

    </main>

    <!-- ====================================== -->
    <!-- â­ Footerï¼ˆè¨­å®šæŒ‰éˆ•ï¼‰ -->
    <!-- ====================================== -->

    <footer class="footer">
        <button id="openSettings" class="settings-btn">âš™ï¸</button>
    </footer>

    <!-- ====================================== -->
    <!-- ğŸ€ MODALS -->
    <!-- ====================================== -->

    <!-- ä¸»é¡Œé¸æ“‡ (åˆå§‹é€²å…¥) -->
    <div id="themeModal" class="modal hidden">
        <div class="modal-content">
            <h2>é¸æ“‡ä½ çš„ä¸»é¡Œè‰² ğŸŒˆ</h2>
            <p style="color:var(--text-dark); opacity:0.7; margin-bottom:20px;">é¸ä¸€å€‹æƒ³é™ªå°è‘µè·³èˆçš„ä¸»é¡Œå§ï¼</p>
            <div class="theme-grid" id="initThemeGrid">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æš±ç¨±è¨­å®š -->
    <div id="nameModal" class="modal hidden">
        <div class="modal-content">
            <h2>ä½ æƒ³ç”¨ä»€éº¼æš±ç¨±é™ªå°è‘µè·³èˆå‘¢ï¼Ÿ</h2>
            <input id="nicknameInput" class="input" placeholder="è¼¸å…¥æš±ç¨±â€¦" style="margin-top:20px;" />
            <button id="saveNickname" class="modal-btn" style="width:100%; margin-top:10px;">ç¢ºèª</button>
        </div>
    </div>
    
    <!-- é˜²è©é¨™æé†’ -->
    <div id="voteWarningModal" class="modal hidden">
        <div class="modal-content">
            <h3 style="color:var(--accent); margin-bottom:15px;">âš ï¸ æº«é¦¨æé†’</h3>
            <p style="text-align:left; line-height:1.6; color:var(--text-dark); font-size: 0.95rem;">
                ç‚ºäº†ç¢ºä¿æŠ•ç¥¨å…¬æ­£ï¼Œé»æ“Šå‰å¾€æŠ•ç¥¨æ™‚ï¼Œç¶²é æœƒè¦æ±‚<strong>ç™»å…¥ LINE å¸³è™Ÿ</strong>é€²è¡Œé©—è­‰ã€‚<br><br>
                è«‹æ”¾å¿ƒï¼Œé€™çµ•å°<strong>ä¸æ˜¯è©é¨™</strong>ï¼Œæ˜¯ä¸‰éº—é·—å®˜æ–¹çš„æ­£è¦æŠ•ç¥¨æ©Ÿåˆ¶å–”ï¼ğŸ”’
            </p>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button id="confirmVoteBtn" class="modal-btn" style="width:100%;">æˆ‘çŸ¥é“äº†ï¼Œå‰å¾€æŠ•ç¥¨ â¡ï¸</button>
            </div>
            <button id="cancelVoteBtn" class="small-btn" style="margin-top:10px; border:none; color:#999; width:100%;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- è¨­å®šé  -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content settings-box">
            <h2>âš™ï¸ è¨­å®š</h2>

            <label class="label">æš±ç¨±</label>
            <input id="nicknameEdit" class="input" />

            <label class="label">åˆ‡æ›ä¸»é¡Œ</label>
            <!-- é€™è£¡ç›´æ¥åµŒå…¥æŒ‰éˆ•æ ¼ï¼Œæ–¹ä¾¿åˆ‡æ› -->
            <div class="theme-grid" id="settingsThemeGrid" style="margin-top:10px; margin-bottom:20px;">
                 <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <label class="label">å¾½ç« å±•ç¤ºæ¨¡å¼</label>
            <select id="styleSelector" class="input">
                <option value="grid">å°å¡</option>
                <option value="big">å¤§å¡</option>
                <option value="carousel">è¼ªæ’­</option>
            </select>
            
            <label class="label">å¾½ç« é€ å‹</label>
            <select id="shapeSelector" class="input">
                <option value="default">é è¨­ (åœ“è§’)</option>
                <option value="circle">åœ“å½¢æ³¡æ³¡</option>
                <option value="stamp">éƒµç¥¨é¢¨æ ¼</option>
                <option value="glow">ç™¼å…‰ç‰¹æ•ˆ</option>
            </select>

            <button id="resetData" class="delete-btn">âš ï¸ æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
            <button id="closeSettings" class="modal-btn" style="width:100%; margin-top:10px;">å„²å­˜ä¸¦é—œé–‰</button>
        </div>
    </div>

    <!-- åˆ†äº«ç•«é¢ (å«ç¥ç¦èªè¼¸å…¥) -->
    <div id="shareModal" class="modal hidden">
        <div class="share-content">
            <div class="modal-content" style="width:100%; max-width:100%; padding:20px;">
                <h3 style="color:var(--accent); margin-bottom:10px;">å¯«ä¸‹ä½ çš„ç¥ç¦ ğŸ’Œ</h3>
                <textarea id="shareWishInput" class="textarea" rows="2" placeholder="åœ¨é€™è£¡è¼¸å…¥æƒ³å°å°è‘µèªªçš„è©±... (ç•™ç©ºå‰‡ä¸é¡¯ç¤º)"></textarea>
                
                <h3 style="color:var(--text-dark); margin:15px 0 10px; font-size:16px;">é è¦½ä½ çš„æ‡‰æ´å¡</h3>
                <p style="font-size:12px; color:#999; margin-bottom:5px;">(å¡ç‰‡æ¨£å¼æœƒéš¨æ‰“å¡å¤©æ•¸è®ŠåŒ–å–”ï¼)</p>
                
                <!-- çœŸæ­£æˆªåœ–çš„å€å¡Š -->
                <div id="shareCard" class="share-card">
                    <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div class="share-actions">
                     <button id="downloadCardBtn" class="modal-btn" style="background:var(--accent);">ğŸ“¥ å„²å­˜åœ–ç‰‡</button>
                     <button id="shareNativeBtn" class="modal-btn" style="background:var(--btn-bg);">ğŸ“¤ åˆ†äº«</button>
                </div>
                
                <p style="font-size:11px; color:#999; margin-top:8px; line-height:1.4;">
                    ğŸ’¡ æ‰‹æ©Ÿç‰ˆï¼šã€Œå„²å­˜åœ–ç‰‡ã€å¾Œé•·æŒ‰å¯å­˜åˆ°ç›¸ç°¿<br>
                    ã€Œåˆ†äº«ã€å¯ç›´æ¥åˆ†äº«åœ–ç‰‡åˆ° IG/LINE ç­‰ç¤¾ç¾¤
                </p>
                
                <button id="closeShare" class="modal-btn" style="width:100%; margin-top:10px; background:#ccc; color:#666;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯æ˜Ÿæ˜Ÿ -->
    <div id="starBackground"></div>

    <script>
        /* ===========================================
           ğŸŒ¸ LocalStorage è³‡æ–™æ¨¡å‹åˆå§‹åŒ–
        =========================================== */

        const STORAGE_KEY = "dreamStageDataV2"; 
        const DEADLINE = new Date("2025-12-22T23:59:59");
        const PAGE_URL = window.location.href; 
        
        // æ™®é€šå¾½ç« æ±  (ç§»é™¤å‘æ—¥è‘µï¼Œç¢ºä¿å®ƒæ˜¯ç¨€æœ‰çš„)
        const BADGE_POOL = [
            "ğŸ€", "ğŸŒ¸", "ğŸ¬", "ğŸ­", "ğŸ®", "â˜ï¸", "ğŸ", "ğŸ“", "ğŸ§", "ğŸ§¸", 
            "ğŸ¦„", "ğŸ°", "ğŸ±", "ğŸ¶", "â­", "ğŸŒ™", "ğŸµ", "ğŸ¤", "ğŸ‘‘", "ğŸ’",
            "ğŸ¨", "ğŸš€", "ğŸ¡", "ğŸ°", "ğŸ§¶", "ğŸ•¶ï¸", "ğŸ’", "â˜‚ï¸", "ğŸ©°", "ğŸŸï¸"
        ];

        const THEMES = [
            { id: "melody", name: "ğŸ€ Melody" },
            { id: "cinnamoroll", name: "â˜ï¸ Cinnamoroll" },
            { id: "kuromi", name: "ğŸ’œ Kuromi" },
            { id: "pompompurin", name: "â­ å¸ƒä¸ç‹—" },
            { id: "kitty", name: "ğŸ€ Kitty" }
        ];

        function loadData() {
            try {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
                
                const defaultData = {
                    nickname: "",
                    theme: "",
                    badges: [], 
                    lastVote: "",
                    startDate: new Date().toISOString(),
                    myWish: "", 
                    badgeStyle: "grid",
                    badgeShape: "default", 
                    starLevel: 0,
                    hasSeenVoteWarning: false 
                };

                if (data) return { ...defaultData, ...data };
                return defaultData;
            } catch (e) {
                console.error("è³‡æ–™è®€å–å¤±æ•—ï¼Œé‡ç½®ç‚ºé è¨­å€¼", e);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚å›å‚³é è¨­å€¼ï¼Œé¿å…å¡æ­»
                return {
                    nickname: "",
                    theme: "",
                    badges: [], 
                    lastVote: "",
                    startDate: new Date().toISOString(),
                    myWish: "", 
                    badgeStyle: "grid",
                    badgeShape: "default", 
                    starLevel: 0,
                    hasSeenVoteWarning: false 
                };
            }
        }

        let DATA = loadData();

        /* ===========================================
           ğŸŒ¸ å·¥å…·å‡½å¼
        =========================================== */

        function save() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA));
            } catch (e) {
                console.error("å„²å­˜å¤±æ•—", e);
                // å¦‚æœæ˜¯åœ¨ç„¡ç—•æ¨¡å¼æˆ–å®¹é‡æ»¿äº†ï¼Œè·³å‡ºæç¤º
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    alert("âš ï¸ ç„¡æ³•å„²å­˜é€²åº¦ï¼\næ‚¨çš„ç€è¦½å™¨å„²å­˜ç©ºé–“å·²æ»¿ï¼Œæˆ–é–‹å•Ÿäº†ã€Œç§å¯†/ç„¡ç—•æ¨¡å¼ã€ã€‚\nè«‹æ”¹ç”¨ä¸€èˆ¬ç€è¦½å™¨é–‹å•Ÿï¼Œä»¥å…å¾½ç« æ¶ˆå¤±å–”ï¼");
                }
            }
        }

        function $(id) {
            return document.getElementById(id);
        }

        function getTotalSlots() {
            const start = new Date(DATA.startDate);
            start.setHours(0,0,0,0); 
            const end = new Date(DEADLINE);
            
            let diffTime = end - start;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 1) diffDays = 1; 
            return diffDays;
        }

        /* ===========================================
           ğŸŒˆ ä¸»é¡Œåˆ‡æ›é‚è¼¯ (å« UI ç”Ÿæˆ)
        =========================================== */

        function renderThemeButtons(containerId, isSettings = false) {
            const container = $(containerId);
            container.innerHTML = "";
            
            THEMES.forEach(theme => {
                const btn = document.createElement("button");
                btn.className = "theme-btn";
                btn.dataset.theme = theme.id;
                btn.textContent = theme.name;
                
                // è¨­å®šé é¢ä¸­ï¼Œæ¨™ç¤ºç›®å‰é¸ä¸­çš„ä¸»é¡Œ
                if (isSettings && DATA.theme === theme.id) {
                    btn.classList.add("active");
                    btn.style.border = "2px solid var(--accent)";
                }

                btn.onclick = () => {
                    DATA.theme = theme.id;
                    save();
                    applyTheme();
                    
                    if (isSettings) {
                        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                        renderThemeButtons("settingsThemeGrid", true);
                    } else {
                        $("themeModal").classList.add("hidden");
                        askNicknameIfNeeded();
                    }
                };
                container.appendChild(btn);
            });
        }

        function applyTheme() {
            document.body.className = "";
            if (DATA.theme) {
                document.body.setAttribute('data-theme', DATA.theme);
            }
        }

        /* ===========================================
           â˜ï¸ é¦–æ¬¡é€²ç«™ & æš±ç¨±
        =========================================== */

        function askThemeIfNeeded() {
            if (!DATA.theme) {
                renderThemeButtons("initThemeGrid", false);
                $("themeModal").classList.remove("hidden");
            }
        }

        function askNicknameIfNeeded() {
            if (!DATA.nickname) {
                $("nameModal").classList.remove("hidden");
            } else {
                updateGreeting();
            }
        }

        $("saveNickname").onclick = () => {
            const name = $("nicknameInput").value.trim();
            if (!name) return;
            DATA.nickname = name;
            save();
            $("nameModal").classList.add("hidden");
            updateGreeting();
        };

        function updateGreeting() {
            $("greeting").textContent = `æ­¡è¿å›ä¾†ï¼Œ${DATA.nickname} ğŸŒŸ`;
        }
        
        // --- æŠ•ç¥¨é€£çµæ””æˆª ---
        const voteLink = $("voteLinkBtn");
        
        voteLink.addEventListener('click', (e) => {
            if (!DATA.hasSeenVoteWarning) {
                e.preventDefault(); // é˜»æ­¢è·³è½‰
                $("voteWarningModal").classList.remove("hidden");
            }
        });

        $("confirmVoteBtn").onclick = () => {
            DATA.hasSeenVoteWarning = true;
            save();
            $("voteWarningModal").classList.add("hidden");
            window.open(voteLink.href, '_blank');
        };

        $("cancelVoteBtn").onclick = () => {
            $("voteWarningModal").classList.add("hidden");
        };


        /* ===========================================
           ğŸ’¬ ä»Šæ—¥å°èª (åŠ‡æƒ…æ¨¡å¼)
        =========================================== */

        function getCurrentDayNumber() {
            const start = new Date(DATA.startDate);
            start.setHours(0,0,0,0);
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // è¨ˆç®—ä»Šå¤©æ˜¯ç¬¬å¹¾å¤© (å¾ 1 é–‹å§‹)
            let diffTime = today - start;
            let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            if (diffDays < 1) diffDays = 1;
            return diffDays;
        }

        const QUOTE_START = "ä»Šå¤©æ˜¯ç¬¬ä¸€å¤©â€¦å°è‘µæœ‰ä¸€é»é»å°å®³ç¾ï½å¯ä»¥é™ªæˆ‘ä¸€èµ·è·³è·³å—ï¼ŸğŸ©°ğŸ’—";
        
        const QUOTES_MIDDLE = [
            "æˆ‘æŠŠå°èˆæ­¥è·³çµ¦é›²æœµçœ‹ï½é›²æœµèªªæˆ‘è·³å¾—è»Ÿæ£‰æ£‰çš„ â˜ï¸ğŸ©°",
            "ä»Šå¤©è½‰åœˆåœˆâ€¦æˆ‘æ²’æœ‰å€’ï¼æˆ‘è®Šæˆä¸æœƒæšˆçš„å°å‹‡å£« âœ¨",
            "è·Œå€’äº†â€¦å¯æ˜¯æˆ‘ä¸€ä¸‹å­å°±ç«™èµ·ä¾†ï¼å› ç‚ºæˆ‘æƒ³è·³å¾—æ›´å¥½ï½ğŸŒˆ",
            "ä»Šå¤©æƒ³è·³çµ¦æ˜Ÿæ˜Ÿï½æ˜Ÿæ˜Ÿçœ¨çœ¼çœ¼è·Ÿæˆ‘èªªï¼šå°è‘µæœ€æ£’äº† â­",
            "è¬è¬ä½ æ¯å¤©éƒ½ä¾†çœ‹æˆ‘ï½ä½ ä¸€ä¾†æˆ‘è‚šå­è£¡å°±è®Šæš–æš–çš„ â¤ï¸",
            "é¢¨å¹è‘—æˆ‘çš„è£™è£™ï½å®ƒèªªï¼šå˜¿ï¼Œæˆ‘æŠŠä½ æ‰˜é«˜ä¸€é»é»å–”âœ¨",
            "é›¢å¾ˆäº®äº®çš„èˆå°è¶Šã€ä¾†ã€è¶Šã€è¿‘ï¼å°è‘µå¿ƒè£¡åœ¨è·³è¹¦è¹¦è·³ ğŸ€",
            "ä»Šå¤©æƒ³è·³å¾—äº®äº®äº®ï½åƒå°ç‡ˆæ³¡ä¸€æ¨£äº®åˆ°æœƒå®³ç¾ ğŸŒŸ",
            "æˆ‘å€‘å¿«å®Œæˆæƒ¹ï¼åŠ æ²¹åŠ æ²¹ï½æˆ‘æŠ“è‘—ä½ çš„æ‰‹ä¸€èµ·å‰é€² ğŸ’–"
        ];

        const QUOTE_END = "è€¶ï½è·³å®Œäº†ï¼å¯æ˜¯â€¦å°è‘µé‚„æƒ³å†è·³ä¸€æ¬¡çµ¦ä½ çœ‹å¯ä»¥å—ï¼Ÿâœ¨ğŸ©°ğŸ’—";

        function updateDailyQuote() {
            const currentDay = getCurrentDayNumber();
            const totalDays = getTotalSlots();
            const quoteEl = $("dailyQuote");
            
            if (currentDay <= 1) {
                // ç¬¬ä¸€å¤©
                quoteEl.textContent = QUOTE_START;
            } else if (currentDay >= totalDays) {
                // æœ€å¾Œä¸€å¤© (æˆ–æ´»å‹•çµæŸå¾Œ)
                quoteEl.textContent = QUOTE_END;
            } else {
                // ä¸­é–“çš„å¤©æ•¸ï¼šè¼ªæ’­ä¸­é–“çš„èªéŒ„
                // ä½¿ç”¨ (currentDay - 2) ç¢ºä¿ç¬¬äºŒå¤©å¾é™£åˆ—ç¬¬ 0 å€‹é–‹å§‹
                // ä½¿ç”¨ % å–é¤˜æ•¸ï¼Œç¢ºä¿è¶…éé™£åˆ—é•·åº¦æ™‚æœƒå¾ªç’°ï¼Œä¸æœƒå ±éŒ¯
                const index = (currentDay - 2) % QUOTES_MIDDLE.length;
                quoteEl.textContent = QUOTES_MIDDLE[Math.abs(index)];
            }
        }

        /* ===========================================
           ğŸ€ éš¨æ©Ÿå¾½ç« ç³»çµ±
        =========================================== */

        function getShapeClass() {
            return `shape-${DATA.badgeShape || 'default'}`;
        }

        function renderTodayBadge() {
            const today = new Date().toLocaleDateString();
            const badgeEl = $("todayBadge");
            
            // é‡ç½® class ä¸¦åŠ ä¸Šé€ å‹ class
            badgeEl.className = "today-badge " + getShapeClass();

            if (DATA.lastVote === today && DATA.badges.length > 0) {
                const latestBadge = DATA.badges[DATA.badges.length - 1];
                badgeEl.textContent = latestBadge.icon;
            } else {
                badgeEl.textContent = "â“";
            }
        }

        function unlockBadge() {
            const today = new Date().toLocaleDateString();
            const now = new Date();

            if (now > DEADLINE) {
                alert("æ´»å‹•å·²ç¶“çµæŸå›‰ï¼è¬è¬ä½ çš„åƒèˆ‡ï¼ğŸŒ¸");
                return;
            }

            if (DATA.lastVote === today) {
                $("voteMsg").textContent = "ä»Šå¤©å·²ç¶“é ˜éå¾½ç« å›‰ï¼æ˜å¤©å†ä¾†å§ï¼";
                return;
            }

            // --- æŠ½çé‚è¼¯é–‹å§‹ ---
            let randomIcon;
            let isSuperRare = false;

            // è¨­å®šè¶…ç´šå¤§çæ©Ÿç‡ (ä¾‹å¦‚ 0.02 = 2%)
            const SUPER_RARE_CHANCE = 0.02; 

            if (Math.random() < SUPER_RARE_CHANCE) {
                // ä¸­å¤§çï¼
                randomIcon = "ğŸŒ»"; // å‘æ—¥è‘µ
                isSuperRare = true;
            } else {
                // æ™®é€šç
                randomIcon = BADGE_POOL[Math.floor(Math.random() * BADGE_POOL.length)];
            }
            // --- æŠ½çé‚è¼¯çµæŸ ---
            
            DATA.badges.push({
                icon: randomIcon,
                date: today,
                timestamp: now.getTime()
            });
            DATA.lastVote = today;
            save();

            const badgeEl = $("todayBadge");
            badgeEl.textContent = randomIcon;
            
            // ç¢ºä¿å¥—ç”¨æ­£ç¢ºçš„é€ å‹èˆ‡å‹•ç•«
            badgeEl.className = "today-badge " + getShapeClass();
            void badgeEl.offsetWidth; 
            badgeEl.classList.add("animate-pop");

            renderBadges();
            renderJourney();
            generateStars();

            // æ ¹æ“šæ˜¯å¦ä¸­å¤§çé¡¯ç¤ºä¸åŒè¨Šæ¯
            const msgEl = $("voteMsg");
            if (isSuperRare) {
                // æ›´æ–°ç‚ºæŒ‡å®šçš„ä¸­çæç¤ºèª
                msgEl.innerHTML = `ğŸ‰ <strong>æ­å–œæŠ½ä¸­éš±è—ç‰ˆå‘æ—¥è‘µï¼ğŸŒ»</strong><br>è¨˜å¾—åˆ†äº«è²¼æ–‡ä¸¦æˆªåœ–å›å‚³çµ¦æˆ‘ / tagæˆ‘ï¼Œå¯å…Œæ› 45å…ƒé£²æ–™ä¸€æ¯ï¼ğŸ¥¤`;
                msgEl.style.color = "#ff4757"; // ç‰¹åˆ¥çš„ç´…è‰²
                msgEl.style.fontSize = "1rem";
                msgEl.style.lineHeight = "1.5";
                // è‡ªå‹•è§¸ç™¼æ…¶ç¥ç‰¹æ•ˆ (ä¾‹å¦‚å¤šä¸€é»æ˜Ÿæ˜Ÿ)
                for(let i=0; i<20; i++) setTimeout(generateStars, i*100);
            } else {
                msgEl.textContent = `ç²å¾—äº†æ–°å¾½ç« ï¼š${randomIcon} âœ¨`;
                msgEl.style.color = "var(--accent)";
                msgEl.style.fontSize = "0.95rem";
            }
            
            $("voteBtn").classList.add("disabled");
            $("voteBtn").textContent = "ä»Šå¤©å·²å®Œæˆï¼âœ…";
        }

        $("voteBtn").onclick = unlockBadge;

        /* ===========================================
           ğŸŒˆ å¾½ç« å±•ç¤ºæ¨¡å¼
        =========================================== */

        function renderBadges() {
            const grid = $("badgeGrid");
            const carousel = $("badgeCarousel");
            grid.classList.remove("big");
            grid.classList.remove("hidden");
            carousel.classList.add("hidden");

            const style = DATA.badgeStyle;
            const shapeClass = getShapeClass();

            if($("badgeStyleSelector")) $("badgeStyleSelector").value = style;

            const totalSlots = getTotalSlots();
            const earnedCount = DATA.badges.length;

            if (style === "grid" || style === "big") {
                grid.innerHTML = "";
                if (style === "big") grid.classList.add("big");

                for (let i = 0; i < totalSlots; i++) {
                    const div = document.createElement("div");
                    
                    if (i < earnedCount) {
                        div.className = `badge unlocked ${shapeClass}`;
                        div.textContent = DATA.badges[i].icon;
                    } else {
                        div.className = `badge locked ${shapeClass}`;
                        div.textContent = `Day ${i + 1}`;
                    }
                    grid.appendChild(div);
                }
            }

            if (style === "carousel") {
                grid.classList.add("hidden");
                carousel.classList.remove("hidden");
                carousel.innerHTML = "";

                if (earnedCount === 0) {
                     carousel.innerHTML = "<span style='padding:20px; color:#999;'>å¿«å»æŠ•ç¥¨æ”¶é›†å¾½ç« å§ï¼</span>";
                } else {
                    DATA.badges.forEach(b => {
                        const div = document.createElement("div");
                        div.className = `badge unlocked ${shapeClass}`;
                        div.textContent = b.icon;
                        carousel.appendChild(div);
                    });
                }
            }
        }

        $("badgeStyleSelector").onchange = (e) => {
            DATA.badgeStyle = e.target.value;
            save();
            renderBadges();
        };

        /* ===========================================
           ğŸŒˆ æ—…ç¨‹ç´€éŒ„
        =========================================== */

        function renderJourney() {
            const totalSlots = getTotalSlots();
            const current = DATA.badges.length;
            
            $("journeyText").textContent =
                `å·²æ”¶é›† ${current} å€‹å¾½ç« `;
            
            $("targetText").textContent = 
                `ç›®æ¨™ï¼šè§£é– ${totalSlots} å¤©çš„å¾½ç« ç´€éŒ„ï¼`;

            const percent = Math.min((current / totalSlots) * 100, 100);
            $("journeyBar").style.width = percent + "%";
            
            const today = new Date().toLocaleDateString();
            if (DATA.lastVote === today) {
                $("voteBtn").classList.add("disabled");
                $("voteBtn").textContent = "ä»Šå¤©å·²å®Œæˆï¼âœ…";
            } else {
                $("voteBtn").classList.remove("disabled");
                $("voteBtn").textContent = "æˆ‘ä»Šå¤©æœ‰æŠ•ç¥¨ï¼(æŠ½å¾½ç« )";
            }
        }

        /* ===========================================
           ğŸ“· åˆ†äº«ç•«é¢ (å‹•æ…‹è¨­è¨ˆ + ä¸‹è¼‰)
        =========================================== */

        function getCardStyleIndex() {
            // ä½¿ç”¨æ”¶é›†å¾½ç« æ•¸ä¾†æ±ºå®šä»Šå¤©çš„æ¨£å¼ (0-4)
            // é€™æ¨£æ¯å¤©æ”¶é›†æ–°å¾½ç« å¾Œï¼Œå¡ç‰‡èƒŒæ™¯å°±æœƒè®Š
            return DATA.badges.length % 5;
        }

        function updateShareCardPreview() {
            const shareCard = $("shareCard");
            const todayBadge = DATA.badges.length > 0 ? DATA.badges[DATA.badges.length - 1].icon : "ğŸ¥š";
            const wish = $("shareWishInput").value.trim();
            const badgeCount = DATA.badges.length;
            
            // é‡ç½®æ‰€æœ‰ style class
            shareCard.className = "share-card";
            // åŠ å…¥ä»Šæ—¥é™å®šæ¨£å¼
            const styleIndex = getCardStyleIndex();
            shareCard.classList.add(`style-${styleIndex}`);
            
            let wishHtml = "";
            if (wish) {
                wishHtml = `
                <div style="background:rgba(255,255,255,0.7); padding:15px; border-radius:15px; margin-bottom:15px; border:2px dashed var(--card-border);">
                    <p style="font-size:1.1rem; color:var(--text-dark); font-weight:bold; word-wrap:break-word; margin:0;">${wish}</p>
                </div>`;
            }

            // æ ¹æ“šè¨­å®šçš„é€ å‹æ”¹è®Šåˆ†äº«å¡ç‰‡ä¸Šçš„å¤§å¾½ç« 
            const shapeClass = getShapeClass();

            shareCard.innerHTML = `
                <h3 style="margin-bottom:5px; color:var(--accent); font-size:1.3rem; text-shadow:1px 1px 0 #fff;">${DATA.nickname} çš„æ‡‰æ´å¡</h3>
                
                <div class="share-badge-large ${shapeClass}">
                    ${todayBadge}
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-num">${badgeCount}</div>
                        <div class="stat-label">ç²å¾—å¾½ç« </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-num">${badgeCount}</div>
                        <div class="stat-label">æ‰“å¡å¤©æ•¸</div>
                    </div>
                </div>

                ${wishHtml}

                <div style="color:var(--text-dark); opacity:0.7; font-size:0.8rem; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px; display:flex; flex-direction:column; gap:5px;">
                    <span style="font-weight:bold;">#å°è‘µçš„ä¸‰éº—é·—å¤¢æƒ³èˆå°</span>
                    <span>${new Date().toLocaleDateString()}</span>
                    <span style="font-size:0.7rem;">sanriokids.sanrio.com.tw</span>
                </div>
            `;
        }

        // é–‹å•Ÿåˆ†äº«
        $("shareBtn").onclick = () => {
            $("shareModal").classList.remove("hidden");
            $("shareWishInput").value = DATA.myWish;
            updateShareCardPreview();
        };

        // å³æ™‚é è¦½
        $("shareWishInput").addEventListener("input", (e) => {
            DATA.myWish = e.target.value;
            save(); 
            updateShareCardPreview();
        });

        // ä¸‹è¼‰åœ–ç‰‡ (æ‰‹æ©Ÿç‰ˆæœƒå¼•å°é•·æŒ‰å„²å­˜)
        $("downloadCardBtn").onclick = () => {
            const element = document.getElementById("shareCard");
            const originalStyle = element.style.cssText;
            
            // å¼·åˆ¶å›ºå®šå¯¬åº¦ä»¥ç²å¾—æœ€ä½³æˆªåœ–æ•ˆæœ
            element.style.width = "360px"; 
            element.style.margin = "0 auto";
            element.style.transform = "none";

            html2canvas(element, {
                backgroundColor: null, // ä¿ç•™ CSS ä¸­çš„èƒŒæ™¯è¨­å®š
                scale: 2
            }).then(canvas => {
                element.style.cssText = originalStyle;
                
                // åµæ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿè£ç½®
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // æ‰‹æ©Ÿç‰ˆï¼šé¡¯ç¤ºåœ–ç‰‡ä¸¦å¼•å°é•·æŒ‰å„²å­˜
                    const imgWindow = window.open('');
                    imgWindow.document.write(`
                        <html>
                        <head>
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                body { 
                                    margin: 0; 
                                    padding: 20px; 
                                    background: #f5f5f5; 
                                    font-family: system-ui, -apple-system, sans-serif;
                                    text-align: center;
                                }
                                .tip { 
                                    background: #fff; 
                                    padding: 15px; 
                                    border-radius: 10px; 
                                    margin-bottom: 15px;
                                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                }
                                img { 
                                    max-width: 100%; 
                                    border-radius: 15px; 
                                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                                }
                                .instruction {
                                    color: #ff66a3;
                                    font-weight: bold;
                                    font-size: 16px;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="tip">
                                <p class="instruction">ğŸ“± é•·æŒ‰ä¸‹æ–¹åœ–ç‰‡</p>
                                <p style="color: #666; font-size: 14px;">é¸æ“‡ã€Œå„²å­˜åœ–ç‰‡ã€æˆ–ã€ŒåŠ å…¥ç›¸ç‰‡ã€<br>å³å¯å„²å­˜åˆ°ç›¸ç°¿ï¼</p>
                            </div>
                            <img src="${canvas.toDataURL('image/png')}" alt="å°è‘µæ‡‰æ´å¡">
                        </body>
                        </html>
                    `);
                } else {
                    // é›»è…¦ç‰ˆï¼šç›´æ¥ä¸‹è¼‰
                    const link = document.createElement('a');
                    link.download = `å°è‘µæ‡‰æ´å¡_Day${DATA.badges.length}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }
            });
        };

        // åˆ†äº«åœ–ç‰‡åˆ°ç¤¾ç¾¤åª’é«”
        $("shareNativeBtn").onclick = async () => {
            const element = document.getElementById("shareCard");
            const originalStyle = element.style.cssText;
            
            element.style.width = "360px"; 
            element.style.margin = "0 auto";
            element.style.transform = "none";

            html2canvas(element, {
                backgroundColor: null,
                scale: 2
            }).then(async (canvas) => {
                element.style.cssText = originalStyle;
                
                // å°‡ canvas è½‰æ›ç‚º blob
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `å°è‘µæ‡‰æ´å¡_Day${DATA.badges.length}.png`, { type: 'image/png' });
                    
                    const shareData = {
                        title: 'å°è‘µçš„ä¸‰éº—é·—å¤¢æƒ³èˆå°',
                        text: `æˆ‘å·²ç¶“é€£çºŒæ‡‰æ´ ${DATA.badges.length} å¤©äº†ï¼å¿«ä¾†ä¸€èµ·å¹«å°è‘µåŠ æ²¹ï¼ğŸ€\n\n#å°è‘µçš„ä¸‰éº—é·—å¤¢æƒ³èˆå°`,
                        files: [file]
                    };

                    // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´åˆ†äº«åœ–ç‰‡
                    if (navigator.canShare && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                console.log('åˆ†äº«å¤±æ•—ï¼Œé™ç´šç‚ºè¤‡è£½é€£çµ', err);
                                fallbackShare();
                            }
                        }
                    } else {
                        // ä¸æ”¯æ´åˆ†äº«åœ–ç‰‡ï¼Œé™ç´šç‚ºè¤‡è£½é€£çµ
                        fallbackShare();
                    }
                }, 'image/png');
            });
        };
        
        // é™ç´šæ–¹æ¡ˆï¼šè¤‡è£½é€£çµ
        function fallbackShare() {
            const shareText = `æˆ‘å·²ç¶“é€£çºŒæ‡‰æ´ ${DATA.badges.length} å¤©äº†ï¼å¿«ä¾†ä¸€èµ·å¹«å°è‘µåŠ æ²¹ï¼ğŸ€\n\n${window.location.href}\n\n#å°è‘µçš„ä¸‰éº—é·—å¤¢æƒ³èˆå°`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert("âœ… æ–‡å­—å·²è¤‡è£½ï¼\n\nè«‹ï¼š\n1. å…ˆé»ã€Œä¸‹è¼‰åœ–ç‰‡ (ç™¼IG)ã€å„²å­˜åœ–ç‰‡\n2. æ‰“é–‹ IG ä¸Šå‚³åœ–ç‰‡\n3. è²¼ä¸Šå‰›æ‰è¤‡è£½çš„æ–‡å­—\n\né€™æ¨£å°±èƒ½åŒæ™‚åˆ†äº«åœ–ç‰‡å’Œé€£çµå›‰ï¼");
                });
            } else {
                alert("è«‹æ‰‹å‹•è¤‡è£½é€£çµï¼š\n" + window.location.href);
            }
        }

        $("closeShare").onclick = () => {
            $("shareModal").classList.add("hidden");
        };

        /* ===========================================
           â­ èƒŒæ™¯æ˜Ÿæ˜Ÿ
        =========================================== */

        function generateStars() {
            const container = $("starBackground");
            container.innerHTML = "";
            const count = 15 + DATA.badges.length * 2; 

            for (let i = 0; i < count; i++) {
                const star = document.createElement("div");
                star.className = "star";
                star.style.left = Math.random() * 100 + "%";
                star.style.top = Math.random() * 100 + "%";
                star.style.animationDelay = (Math.random() * 2) + "s";
                container.appendChild(star);
            }
        }

        /* ===========================================
           âš™ï¸ è¨­å®šé 
        =========================================== */

        $("openSettings").onclick = () => {
            $("settingsModal").classList.remove("hidden");
            $("nicknameEdit").value = DATA.nickname;
            
            // åœ¨è¨­å®šé ä¸­ç”Ÿæˆä¸»é¡ŒæŒ‰éˆ•
            renderThemeButtons("settingsThemeGrid", true);
            
            if($("styleSelector")) $("styleSelector").value = DATA.badgeStyle;
            if($("shapeSelector")) $("shapeSelector").value = DATA.badgeShape;
        };

        $("closeSettings").onclick = () => {
            $("settingsModal").classList.add("hidden");
        };

        if($("styleSelector")) {
             $("styleSelector").onchange = (e) => {
                DATA.badgeStyle = e.target.value;
                save();
                renderBadges();
            };
        }
        
        // ç›£è½é€ å‹åˆ‡æ›
        if($("shapeSelector")) {
            $("shapeSelector").onchange = (e) => {
                DATA.badgeShape = e.target.value;
                save();
                renderBadges();
                renderTodayBadge(); // å³æ™‚æ›´æ–°ä»Šæ—¥å¾½ç« 
            };
        }

        $("resetData").onclick = () => {
            if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ(å¾½ç« æœƒå…¨éƒ¨æ¶ˆå¤±å–”)")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        };

        $("nicknameEdit").onchange = (e) => {
            DATA.nickname = e.target.value;
            save();
            updateGreeting();
        };

        /* ===========================================
           ğŸš€ åˆå§‹åŒ–
        =========================================== */
        
        // ç¢ºä¿ DOM å®Œå…¨è¼‰å…¥å¾Œå†åŸ·è¡Œ
        function initApp() {
            const now = new Date();
            if (now > DEADLINE) {
                 if ($("voteMsg")) $("voteMsg").textContent = "æ´»å‹•å·²æ–¼ 12/22 çµæŸï¼Œæ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼";
                 if ($("voteBtn")) {
                     $("voteBtn").classList.add("disabled");
                     $("voteBtn").textContent = "æ´»å‹•çµæŸ";
                     $("voteBtn").onclick = null;
                 }
            }

            applyTheme();
            
            // å„ªåŒ–æµç¨‹ï¼šç¢ºä¿è¦–çª—ä¸æœƒåŒæ™‚è·³å‡ºä¾†
            if (!DATA.theme) {
                // æƒ…æ³ 1ï¼šå®Œå…¨æ–°ä½¿ç”¨è€… -> å…ˆé¸ä¸»é¡Œ
                renderThemeButtons("initThemeGrid", false);
                $("themeModal").classList.remove("hidden");
                // æ³¨æ„ï¼šé¸å®Œä¸»é¡Œçš„æŒ‰éˆ•äº‹ä»¶è£¡ï¼Œæœƒè‡ªå‹•å‘¼å« askNicknameIfNeeded()
            } else {
                // æƒ…æ³ 2ï¼šå·²æœ‰ä¸»é¡Œï¼ˆå¯èƒ½æ˜¯é¸å®Œä¸»é¡Œå¾Œé‡æ–°æ•´ç†ï¼Œæˆ–è€ä½¿ç”¨è€…ï¼‰
                // æª¢æŸ¥æ˜¯å¦éœ€è¦è¼¸å…¥æš±ç¨±
                askNicknameIfNeeded();
            }

            updateDailyQuote();
            renderTodayBadge();
            renderBadges();
            renderJourney();
            generateStars();
        }
        
        // ç•¶ DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>